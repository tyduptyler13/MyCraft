'use strict';var Player=function(a){this.player=new THREE.Object3D;var b=new THREE.Object3D;b.add(a.camera);this.player.add(b);b.position.y=1.7;var c=!1;$("#game > canvas").click(function(){c=!0;this.requestPointerLock()});$(document).on("pointerlockerror",function(){throw Error("Failed to aquire the pointer. Game will not work.");}).on("pointerlockchange",function(){null===document.pointerLockElement&&(c=!1,console.log("Disabled pointer lock."))});$(document).keydown(function(a){});$(document).keyup(function(a){switch(a.which){case 27:c=
!1}});var d=this,e=Math.PI/2;$(document).mousemove(function(a){if(!0===c){var h=a.originalEvent.movementY;d.player.rotation.y-=.002*a.originalEvent.movementX;b.rotation.x-=.0015*h;b.rotation.x=Math.max(-e,Math.min(e,b.rotation.x))}});a.tasks.push(function(a){})};Object.defineProperties(Player.prototype,{mesh:{configurable:!0,enumerable:!0,get:function(){return this.player}},position:{configurable:!0,enumerable:!0,get:function(){return this.player.position},set:function(a){this.player.position.copy(a)}}});THREE.ShaderLib.sky={uniforms:{luminance:{type:"f",value:1},turbidity:{type:"f",value:2},reileigh:{type:"f",value:1},mieCoefficient:{type:"f",value:.005},mieDirectionalG:{type:"f",value:.8},sunPosition:{type:"v3",value:new THREE.Vector3},distance:{type:"f",value:45E4}},vertexShader:"varying vec3 vWorldPosition;\nvoid main() {\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvWorldPosition = worldPosition.xyz;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",
fragmentShader:"uniform sampler2D skySampler;\nuniform vec3 sunPosition;\nuniform float distance;\nvarying vec3 vWorldPosition;\nvec3 cameraPos = vec3(0., 0., 0.);\n// uniform sampler2D sDiffuse;\n// const float turbidity = 10.0; //\n// const float reileigh = 2.; //\n// const float luminance = 1.0; //\n// const float mieCoefficient = 0.005;\n// const float mieDirectionalG = 0.8;\nuniform float luminance;\nuniform float turbidity;\nuniform float reileigh;\nuniform float mieCoefficient;\nuniform float mieDirectionalG;\n// constants for atmospheric scattering\nconst float e = 2.71828182845904523536028747135266249775724709369995957;\nconst float pi = 3.141592653589793238462643383279502884197169;\nconst float n = 1.0003; // refractive index of air\nconst float N = 2.545E25; // number of molecules per unit volume for air at\n// 288.15K and 1013mb (sea level -45 celsius)\nconst float pn = 0.035;\t// depolatization factor for standard air\n// wavelength of used primaries, according to preetham\nconst vec3 lambda = vec3(680E-9, 550E-9, 450E-9);\n// mie stuff\n// K coefficient for the primaries\nconst vec3 K = vec3(0.686, 0.678, 0.666);\nconst float v = 4.0;\n// optical length at zenith for molecules\nconst float rayleighZenithLength = 8.4E3;\nconst float mieZenithLength = 1.25E3;\nconst vec3 up = vec3(0.0, 1.0, 0.0);\nconst float EE = 1000.0;\nconst float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;\n// 66 arc seconds -> degrees, and the cosine of that\n// earth shadow hack\nconst float cutoffAngle = pi/1.95;\nconst float steepness = 1.5;\nvec3 totalRayleigh(vec3 lambda)\n{\nreturn (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn));\n}\n// A simplied version of the total Reayleigh scattering to works on browsers that use ANGLE\nvec3 simplifiedRayleigh()\n{\nreturn 0.0005 / vec3(94, 40, 18);\n}\nfloat rayleighPhase(float cosTheta)\n{\t \nreturn (3.0 / (16.0*pi)) * (1.0 + pow(cosTheta, 2.0));\n//\treturn (1.0 / (3.0*pi)) * (1.0 + pow(cosTheta, 2.0));\n//\treturn (3.0 / 4.0) * (1.0 + pow(cosTheta, 2.0));\n}\nvec3 totalMie(vec3 lambda, vec3 K, float T)\n{\nfloat c = (0.2 * T ) * 10E-18;\nreturn 0.434 * c * pi * pow((2.0 * pi) / lambda, vec3(v - 2.0)) * K;\n}\nfloat hgPhase(float cosTheta, float g)\n{\nreturn (1.0 / (4.0*pi)) * ((1.0 - pow(g, 2.0)) / pow(1.0 - 2.0*g*cosTheta + pow(g, 2.0), 1.5));\n}\nfloat sunIntensity(float zenithAngleCos)\n{\nreturn EE * max(0.0, 1.0 - exp(-((cutoffAngle - acos(zenithAngleCos))/steepness)));\n}\n// float logLuminance(vec3 c)\n// {\n// \treturn log(c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722);\n// }\n// Filmic ToneMapping http://filmicgames.com/archives/75\nfloat A = 0.15;\nfloat B = 0.50;\nfloat C = 0.10;\nfloat D = 0.20;\nfloat E = 0.02;\nfloat F = 0.30;\nfloat W = 1000.0;\nvec3 Uncharted2Tonemap(vec3 x)\n{\nreturn ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvoid main() \n{\nfloat sunfade = 1.0-clamp(1.0-exp((sunPosition.y/distance)),0.0,1.0);\n// luminance =  1.0 ;// vWorldPosition.y / 450000. + 0.5; //sunPosition.y / 450000. * 1. + 0.5;\n// gl_FragColor = vec4(sunfade, sunfade, sunfade, 1.0);\nfloat reileighCoefficient = reileigh - (1.0* (1.0-sunfade));\nvec3 sunDirection = normalize(sunPosition);\nfloat sunE = sunIntensity(dot(sunDirection, up));\n// extinction (absorbtion + out scattering) \n// rayleigh coefficients\nvec3 betaR = simplifiedRayleigh() * reileighCoefficient;\n// mie coefficients\nvec3 betaM = totalMie(lambda, K, turbidity) * mieCoefficient;\n// optical length\n// cutoff angle at 90 to avoid singularity in next formula.\nfloat zenithAngle = acos(max(0.0, dot(up, normalize(vWorldPosition - cameraPos))));\nfloat sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));\nfloat sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));\n// combined extinction factor\t\nvec3 Fex = exp(-(betaR * sR + betaM * sM));\n// in scattering\nfloat cosTheta = dot(normalize(vWorldPosition - cameraPos), sunDirection);\nfloat rPhase = rayleighPhase(cosTheta*0.5+0.5);\nvec3 betaRTheta = betaR * rPhase;\nfloat mPhase = hgPhase(cosTheta, mieDirectionalG);\nvec3 betaMTheta = betaM * mPhase;\nvec3 Lin = pow(sunE * ((betaRTheta + betaMTheta) / (betaR + betaM)) * (1.0 - Fex),vec3(1.5));\nLin *= mix(vec3(1.0),pow(sunE * ((betaRTheta + betaMTheta) / (betaR + betaM)) * Fex,vec3(1.0/2.0)),clamp(pow(1.0-dot(up, sunDirection),5.0),0.0,1.0));\n//nightsky\nvec3 direction = normalize(vWorldPosition - cameraPos);\nfloat theta = acos(direction.y); // elevation --\x3e y-axis, [-pi/2, pi/2]\nfloat phi = atan(direction.z, direction.x); // azimuth --\x3e x-axis [-pi/2, pi/2]\nvec2 uv = vec2(phi, theta) / vec2(2.0*pi, pi) + vec2(0.5, 0.0);\n// vec3 L0 = texture2D(skySampler, uv).rgb+0.1 * Fex;\nvec3 L0 = vec3(0.1) * Fex;\n// composition + solar disc\n//if (cosTheta > sunAngularDiameterCos)\nfloat sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);\n// if (normalize(vWorldPosition - cameraPos).y>0.0)\nL0 += (sunE * 19000.0 * Fex)*sundisk;\nvec3 whiteScale = 1.0/Uncharted2Tonemap(vec3(W));\nvec3 texColor = (Lin+L0);   \ntexColor *= 0.04 ;\ntexColor += vec3(0.0,0.001,0.0025)*0.3;\nfloat g_fMaxLuminance = 1.0;\nfloat fLumScaled = 0.1 / luminance;     \nfloat fLumCompressed = (fLumScaled * (1.0 + (fLumScaled / (g_fMaxLuminance * g_fMaxLuminance)))) / (1.0 + fLumScaled); \nfloat ExposureBias = fLumCompressed;\nvec3 curr = Uncharted2Tonemap((log2(2.0/pow(luminance,4.0)))*texColor);\nvec3 color = curr*whiteScale;\nvec3 retColor = pow(color,vec3(1.0/(1.2+(1.2*sunfade))));\ngl_FragColor.rgb = retColor;\ngl_FragColor.a = 1.0;\n}"};
THREE.Sky=function(a){if(void 0===a||null===a)a=5E3;var b=THREE.ShaderLib.sky,c=THREE.UniformsUtils.clone(b.uniforms),b=new THREE.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,uniforms:c,side:THREE.BackSide});a=new THREE.SphereBufferGeometry(a,32,15);this.mesh=new THREE.Mesh(a,b);this.uniforms=c};var ThreadPool=function(a,b){this.readyThreads=[];this.work=[];this.threads=[];this.valid=!0;b=b||navigator.hardwareConcurrency;for(var c=this,d=function(a){return function(){c.readyThreads.push(a);if(0!==c.work.length){var b=c.work.shift();c.run(b.data,b.callback)}}},e=0;e<b;++e){var g=new Worker(a);$(g).on("message",d(e));$(g).on("error",function(a){console.error("An error has occured on a thread!",a)});this.threads.push(g);this.readyThreads.push(e)}};
ThreadPool.prototype.destroy=function(){this.threads.forEach(function(a){a.terminate()});this.valid=!1};ThreadPool.prototype.run=function(a,b){if(!this.valid)throw Error("Invalid state. This pool was destroyed. No workers available.");if(0<this.readyThreads.length){var c=this.readyThreads.pop();$(this.threads[c]).one("message",function(a){b(a.originalEvent)});this.threads[c].postMessage(a.buffer,[a.buffer])}else this.work.push({data:a,callback:b})};(function(){var a={},b={},c=new THREE.TextureLoader,d={},e=new THREE.MultiMaterial,g=e.visible=!1,h=[];API.getMaterial=function(f,e){a[f]?e(a[f]):async.each(["diffuseMap","normalMap","specularMap"],function(a,e){d[f][a]?c.load(d[f][a],function(c){b[f]||(b[f]={});b[f][a]=c;c.wrapS=c.wrapT=THREE.RepeatWrapping;e()},function(){},function(){e(Error("Texture failed to load."))}):e()},function(c){if(c)throw c;c=new THREE.MeshPhongMaterial({map:b[f].diffuseMap,specularMap:b[f].specularMap,normalMap:b[f].normalMap,
name:d[f].name});a[f]=c;e(c)})};$.ajax({url:"blocks.json",success:function(a){d=a;var b=[];async.forEachOf(a,function(a,c,d){0<=c?API.getMaterial(c,function(a){d();b[c]=a}):d()},function(a){a&&console.error("Unable to prefetch the required textures.");e.materials=b;g=e.visible=!0;h.forEach(function(a){try{a()}catch(b){console.warn("Failed to call callback!",b)}})})},error:function(a,b,c){console.log(a,b,c)}});API.getTexture=function(a,c){return b[a][c]};API.getTextures=function(){return b};API.setAnisotropy=
function(a){for(var c in b)for(var d in b[c]){var e=b[c][d];e.anisotropy=a;e.needsUpdate=!0}};API.getBlockMaterial=function(){return e};API.onBlocksReady=function(a){g?a():h.push(a)}})();
var chunkPool=new ThreadPool("js/ChunkOptimizer.min.js"),Chunk=function(a){this.blocks=new Int8Array(512);this.space=new THREE.Object3D;this.added=!1;var b=this.geometry=new THREE.BufferGeometry;b.frustumCulled=!1;this.attributes={position:new THREE.BufferAttribute(new Float32Array,3),index:new THREE.BufferAttribute(new Uint16Array,1),uv:new THREE.BufferAttribute(new Float32Array,2),normal:new THREE.BufferAttribute(new Float32Array,3)};b.addAttribute("position",this.attributes.position);b.addAttribute("uv",
this.attributes.uv);b.addAttribute("normal",this.attributes.normal);b.setIndex(this.attributes.index);this.mesh=new THREE.Mesh(b,API.getBlockMaterial());this._metaBlocks=[];0!==a&&this.fill(a)};Chunk.prototype.at=function(a,b,c){return this.blocks[a+8*b+64*c]};Chunk.getPos=function(a){return[a&7,a>>3&7,a>>6&7]};Chunk.prototype.set=function(a,b,c,d){a=a+8*b+64*c;if(0>a||511<a)throw Error("Out of bounds.");this.blocks[a]=d};Chunk.prototype.fill=function(a){this.blocks.fill(a)};
Chunk.prototype.walk=function(a){for(var b=0,c=0;8>c;++c)for(var d=0;8>d;++d)for(var e=0;8>e;++e)a(this.blocks[b],e,d,c),b++};
Chunk.prototype.update=function(){var a=this;chunkPool.run(this.blocks.slice(0),function(b){b=b.data;a.attributes.position.array=new Float32Array(b.position);a.attributes.position.needsUpdate=!0;a.attributes.normal.array=new Float32Array(b.normals);a.attributes.normal.needsUpdate=!0;a.attributes.uv.array=new Float32Array(b.uvs);a.attributes.uv.needsUpdate=!0;a.attributes.index.array=new Uint16Array(b.indices);a.attributes.index.needsUpdate=!0;b=new Uint8Array(b.materialIndex);a.geometry.clearGroups();
for(var c=0;c<b.length;++c)a.geometry.addGroup(36*c,36,b[c]);a.added||(API.onBlocksReady(function(){a.space.add(a.mesh)}),a.added=!0)})};Object.defineProperties(Chunk.prototype,{position:{configurable:!0,enumerable:!0,get:function(){return this.space.position},set:function(a){this.space.position.copy(a)}}});Object.defineProperties(Chunk,{material:{configurable:!0,enumerable:!0,get:function(){API.getBlockMaterial()}}});var MyCraft=function(){var a=$(window),b=a.width(),c=a.height();this.chunks=[];this.scene=new THREE.Scene;this.tasks=[];this.ambientLight=new THREE.AmbientLight(4210752);this.scene.add(this.ambientLight);var d=this.renderer=new THREE.WebGLRenderer({antialias:!0});this.renderer.setSize(b,c);var e=this.camera=new THREE.PerspectiveCamera(45,b/c,.1,1E4,b,c);a.resize(function(){b=a.width();c=a.height();e.aspect=b/c;e.updateProjectionMatrix();d.setSize(b,c)});API.setFOV=function(a){e.fov=a;e.updateProjectionMatrix()};
$("#game").append(this.renderer.domElement);this.player=new Player(this);this.scene.add(this.player.mesh);this.setupChunks();this.setupSky(5E3,this.player);this.timer=new THREE.Clock(!0);this.stats=new Stats;$(this.stats.domElement).css({position:"absolute",left:"0",top:"0"});$("body").append(this.stats.domElement);this.setupUI();this.render()};
MyCraft.prototype.render=function(){var a=this.timer.getDelta();this.stats.begin();this.update(a);this.renderer.render(this.scene,this.camera);this.stats.end();var b=this;requestAnimationFrame(function(){b.render()})};MyCraft.prototype.setupPlayer=function(){var a=new Player(this);this.scene.add(a.mesh)};MyCraft.prototype.update=function(a){var b=this;$.each(this.tasks,function(c,d){d.call(b,a)})};
MyCraft.prototype.setupSky=function(a,b){var c={turbidity:10,reileigh:2,mieCoefficient:.005,mieDirectionalG:.8,luminance:1,inclination:.49,azimuth:.3};c.inclination=Date.now()/18E5%2;var d=new THREE.Mesh(new THREE.SphereBufferGeometry(2E4,16,8),new THREE.MeshBasicMaterial({color:16777215}));d.visible=!1;d.fog=!1;var e=new THREE.DirectionalLight(16777215,1);e.position.copy(d.position);e.position.normalize();this.scene.add(e);var g=new THREE.Sky(a);g.mesh.frustumCulled=!1;g.mesh.add(d);g.mesh.position.copy(b.position);
this.scene.add(g.mesh);g.mesh.fog=!1;this.scene.fog=new THREE.FogExp2(0,.0025);for(var h=new THREE.Object3D,f=new THREE.Geometry,t=.9*a,l=0;1E4>l;++l){var m=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()-.5);m.normalize().multiplyScalar(t);f.vertices.push(m)}var n=new THREE.PointsMaterial({size:1,blending:THREE.AdditiveBlending,sizeAttenuation:!1,color:16777215,fog:!1,transparent:!0}),f=new THREE.Points(f,n);f.frustumCulled=!1;h.add(f);h.position.copy(b.position);this.scene.add(h);
var k=g.uniforms;k.distance.value=a;var p=function(b){k.turbidity.value=b.turbidity;k.reileigh.value=b.reileigh;k.luminance.value=b.luminance;k.mieCoefficient.value=b.mieCoefficient;k.mieDirectionalG.value=b.mieDirectionalG;var c=Math.PI*(b.inclination-.5);b=2*Math.PI*(b.azimuth-.5);d.position.x=a*Math.cos(b);d.position.y=a*Math.sin(b)*Math.sin(c);d.position.z=a*Math.sin(b)*Math.cos(c);g.uniforms.sunPosition.value.copy(d.position)};p(c);var q=new THREE.Color(6216),r=(new THREE.Color(16777215)).multiplyScalar(.7);
this.tasks.push(function(){c.inclination=Date.now()/18E5%2;n.opacity=Math.pow(1-Math.abs(1-c.inclination),2);e.intensity=THREE.Math.clamp(d.position.y+1,0,1);0<d.position.y?this.ambientLight.color.copy(q.clone().lerp(r,d.position.y/1E4+.5)):this.ambientLight.color.copy(r.clone().lerp(q,-d.position.y/1E4+.5));p(c);e.position.copy(d.position);e.position.normalize();h.position.copy(b.position);h.lookAt(d.position);g.mesh.position.copy(b.position)})};
MyCraft.prototype.setupChunks=function(){for(var a=0;10>a;++a)for(var b=0;4>b;++b)for(var c=0;10>c;++c){var d=new Chunk((a+b+c)%6);d.position.set(8*(a-5),8*(b-4),8*(c-5));this.scene.add(d.space);this.chunks.push(d);d.update()}};
MyCraft.prototype.setupUI=function(){$("#settingsButton").click(function(){$("#settings").slideToggle()});for(var a=this.renderer.getMaxAnisotropy(),b=$("#anisotropy"),c=2;c<=a;c*=2)b.append('<option value="'+c+'">'+c+"</option>");b.prop("disabled",!1);b.change(function(){var a=b.find(":selected").val();API.setAnisotropy(Number(a))})};$(function(){window.game=new MyCraft});
